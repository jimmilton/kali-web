"""Vulnerability model for tracking security findings."""

import uuid
from decimal import Decimal
from enum import Enum
from typing import TYPE_CHECKING, Any, Dict, List, Optional

from sqlalchemy import ForeignKey, Numeric, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.db.base import Base, GUID, JSONB, TimestampMixin, UUIDMixin

if TYPE_CHECKING:
    from app.models.project import Project
    from app.models.asset import Asset
    from app.models.job import Job
    from app.models.user import User
    from app.models.note import Note


class VulnerabilitySeverity(str, Enum):
    """Vulnerability severity enumeration."""

    INFO = "info"
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"


class VulnerabilityStatus(str, Enum):
    """Vulnerability status enumeration."""

    OPEN = "open"
    CONFIRMED = "confirmed"
    FALSE_POSITIVE = "false_positive"
    REMEDIATED = "remediated"
    ACCEPTED = "accepted"
    IN_PROGRESS = "in_progress"


class Vulnerability(Base, UUIDMixin, TimestampMixin):
    """Vulnerability model for tracking security findings."""

    __tablename__ = "vulnerabilities"

    project_id: Mapped[uuid.UUID] = mapped_column(
        GUID(), ForeignKey("projects.id", ondelete="CASCADE"), nullable=False, index=True
    )
    asset_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("assets.id", ondelete="SET NULL"), nullable=True, index=True
    )

    # Basic info
    title: Mapped[str] = mapped_column(String(500), nullable=False)
    description: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    severity: Mapped[str] = mapped_column(String(20), nullable=False, index=True)
    status: Mapped[str] = mapped_column(
        String(50), default=VulnerabilityStatus.OPEN.value, nullable=False, index=True
    )

    # CVSS and CVE
    cvss_score: Mapped[Optional[Decimal]] = mapped_column(Numeric(3, 1), nullable=True)
    cvss_vector: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    cve_ids: Mapped[List[str]] = mapped_column(JSONB, default=list, nullable=False)
    cwe_ids: Mapped[List[str]] = mapped_column(JSONB, default=list, nullable=False)

    # Evidence and details
    evidence: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    proof_of_concept: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    request: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    response: Mapped[Optional[str]] = mapped_column(Text, nullable=True)

    # Remediation
    remediation: Mapped[Optional[str]] = mapped_column(Text, nullable=True)
    references: Mapped[List[str]] = mapped_column(JSONB, default=list, nullable=False)

    # Additional metadata
    metadata_: Mapped[Dict[str, Any]] = mapped_column(
        "metadata", JSONB, default=dict, nullable=False
    )
    tags: Mapped[List[str]] = mapped_column(JSONB, default=list, nullable=False)

    # Discovery and assignment
    discovered_by: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("jobs.id", ondelete="SET NULL"), nullable=True
    )
    assigned_to: Mapped[Optional[uuid.UUID]] = mapped_column(
        GUID(), ForeignKey("users.id", ondelete="SET NULL"), nullable=True
    )

    # Template reference (for nuclei, etc.)
    template_id: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)
    tool_name: Mapped[Optional[str]] = mapped_column(String(100), nullable=True)

    # Deduplication
    fingerprint: Mapped[Optional[str]] = mapped_column(String(64), nullable=True, index=True)

    # Relationships
    project: Mapped["Project"] = relationship("Project", back_populates="vulnerabilities")
    asset: Mapped[Optional["Asset"]] = relationship("Asset", back_populates="vulnerabilities")
    discovery_job: Mapped[Optional["Job"]] = relationship(
        "Job", back_populates="discovered_vulnerabilities", foreign_keys=[discovered_by]
    )
    assignee: Mapped[Optional["User"]] = relationship(
        "User", back_populates="assigned_vulnerabilities", foreign_keys=[assigned_to]
    )
    notes: Mapped[List["Note"]] = relationship(
        "Note", back_populates="vulnerability", cascade="all, delete-orphan"
    )

    def __repr__(self) -> str:
        return f"<Vulnerability {self.title} ({self.severity})>"
