"""Vulnerability schemas."""

from datetime import datetime
from decimal import Decimal
from typing import Any, Dict, List, Optional
from uuid import UUID

from pydantic import Field

from app.models.vulnerability import VulnerabilitySeverity, VulnerabilityStatus
from app.schemas.common import BaseSchema, PaginatedResponse, TimestampSchema


class VulnerabilityBase(BaseSchema):
    """Base vulnerability schema."""

    title: str = Field(..., min_length=1, max_length=500)
    description: Optional[str] = None
    severity: VulnerabilitySeverity
    status: VulnerabilityStatus = VulnerabilityStatus.OPEN

    # CVSS and identifiers
    cvss_score: Optional[Decimal] = Field(None, ge=0, le=10)
    cvss_vector: Optional[str] = None
    cve_ids: List[str] = []
    cwe_ids: List[str] = []

    # Evidence
    evidence: Optional[str] = None
    proof_of_concept: Optional[str] = None
    request: Optional[str] = None
    response: Optional[str] = None

    # Remediation
    remediation: Optional[str] = None
    references: List[str] = []

    # Tags
    tags: List[str] = []


class VulnerabilityCreate(VulnerabilityBase):
    """Schema for creating a vulnerability."""

    project_id: UUID
    asset_id: Optional[UUID] = None
    template_id: Optional[str] = None
    tool_name: Optional[str] = None


class VulnerabilityUpdate(BaseSchema):
    """Schema for updating a vulnerability."""

    title: Optional[str] = Field(None, min_length=1, max_length=500)
    description: Optional[str] = None
    severity: Optional[VulnerabilitySeverity] = None
    status: Optional[VulnerabilityStatus] = None
    cvss_score: Optional[Decimal] = Field(None, ge=0, le=10)
    cvss_vector: Optional[str] = None
    cve_ids: Optional[List[str]] = None
    cwe_ids: Optional[List[str]] = None
    evidence: Optional[str] = None
    proof_of_concept: Optional[str] = None
    request: Optional[str] = None
    response: Optional[str] = None
    remediation: Optional[str] = None
    references: Optional[List[str]] = None
    tags: Optional[List[str]] = None
    assigned_to: Optional[UUID] = None
    asset_id: Optional[UUID] = None


class VulnerabilityAssetInfo(BaseSchema):
    """Schema for vulnerability asset info."""

    id: UUID
    type: str
    value: str


class VulnerabilityResponse(VulnerabilityBase, TimestampSchema):
    """Schema for vulnerability response."""

    id: UUID
    project_id: UUID
    asset_id: Optional[UUID] = None
    discovered_by: Optional[UUID] = None
    assigned_to: Optional[UUID] = None
    template_id: Optional[str] = None
    tool_name: Optional[str] = None
    fingerprint: Optional[str] = None
    metadata_: Dict[str, Any] = Field(default={}, alias="metadata")

    # Related data
    asset: Optional[VulnerabilityAssetInfo] = None
    assignee_name: Optional[str] = None
    note_count: Optional[int] = None


class VulnerabilityListResponse(PaginatedResponse[VulnerabilityResponse]):
    """Paginated vulnerability list response."""

    pass


class VulnerabilityFilter(BaseSchema):
    """Schema for vulnerability filtering."""

    severities: Optional[List[VulnerabilitySeverity]] = None
    statuses: Optional[List[VulnerabilityStatus]] = None
    asset_ids: Optional[List[UUID]] = None
    assigned_to: Optional[UUID] = None
    cve_id: Optional[str] = None
    cwe_id: Optional[str] = None
    tool_name: Optional[str] = None
    tags: Optional[List[str]] = None
    search: Optional[str] = None
    date_from: Optional[datetime] = None
    date_to: Optional[datetime] = None


class VulnerabilityStats(BaseSchema):
    """Schema for vulnerability statistics."""

    total: int
    by_severity: Dict[str, int]
    by_status: Dict[str, int]
    by_asset_type: Dict[str, int]
    recent_count: int  # Last 7 days
    remediated_count: int


class VulnerabilityBulkUpdate(BaseSchema):
    """Schema for bulk vulnerability update."""

    vulnerability_ids: List[UUID]
    status: Optional[VulnerabilityStatus] = None
    assigned_to: Optional[UUID] = None
    tags_add: Optional[List[str]] = None
    tags_remove: Optional[List[str]] = None


class CVSSCalculator(BaseSchema):
    """Schema for CVSS v3.1 calculator input."""

    attack_vector: str  # N, A, L, P
    attack_complexity: str  # L, H
    privileges_required: str  # N, L, H
    user_interaction: str  # N, R
    scope: str  # U, C
    confidentiality: str  # N, L, H
    integrity: str  # N, L, H
    availability: str  # N, L, H


class CVSSResult(BaseSchema):
    """Schema for CVSS calculation result."""

    score: Decimal
    severity: str
    vector: str
