'use client';

import { useMemo } from 'react';
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
} from 'recharts';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { TrendDataPoint, VulnerabilitySummary } from '@/lib/api';

interface VulnerabilityChartProps {
  trends: TrendDataPoint[];
  summary: VulnerabilitySummary;
}

const SEVERITY_COLORS = {
  critical: '#dc2626',
  high: '#ea580c',
  medium: '#eab308',
  low: '#22c55e',
  info: '#3b82f6',
};

export function VulnerabilityChart({ trends, summary }: VulnerabilityChartProps) {
  const pieData = useMemo(() => {
    return [
      { name: 'Critical', value: summary.critical, color: SEVERITY_COLORS.critical },
      { name: 'High', value: summary.high, color: SEVERITY_COLORS.high },
      { name: 'Medium', value: summary.medium, color: SEVERITY_COLORS.medium },
      { name: 'Low', value: summary.low, color: SEVERITY_COLORS.low },
      { name: 'Info', value: summary.info, color: SEVERITY_COLORS.info },
    ].filter(item => item.value > 0);
  }, [summary]);

  const trendData = useMemo(() => {
    return trends.map(point => ({
      date: new Date(point.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
      vulnerabilities: point.value,
    }));
  }, [trends]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Vulnerabilities</CardTitle>
        <CardDescription>
          {summary.total} total vulnerabilities discovered
        </CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue="severity" className="space-y-4">
          <TabsList>
            <TabsTrigger value="severity">By Severity</TabsTrigger>
            <TabsTrigger value="trend">Trend</TabsTrigger>
          </TabsList>

          <TabsContent value="severity" className="h-[250px]">
            {pieData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={pieData}
                    cx="50%"
                    cy="50%"
                    innerRadius={60}
                    outerRadius={90}
                    paddingAngle={2}
                    dataKey="value"
                    label={({ name, value }) => `${name}: ${value}`}
                    labelLine={false}
                  >
                    {pieData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={entry.color} />
                    ))}
                  </Pie>
                  <Tooltip />
                  <Legend />
                </PieChart>
              </ResponsiveContainer>
            ) : (
              <div className="flex h-full items-center justify-center text-muted-foreground">
                No vulnerabilities found
              </div>
            )}
          </TabsContent>

          <TabsContent value="trend" className="h-[250px]">
            {trendData.length > 0 ? (
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={trendData}>
                  <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                  <XAxis
                    dataKey="date"
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                  />
                  <YAxis
                    fontSize={12}
                    tickLine={false}
                    axisLine={false}
                    allowDecimals={false}
                  />
                  <Tooltip />
                  <Area
                    type="monotone"
                    dataKey="vulnerabilities"
                    stroke="#ea580c"
                    fill="#ea580c"
                    fillOpacity={0.2}
                  />
                </AreaChart>
              </ResponsiveContainer>
            ) : (
              <div className="flex h-full items-center justify-center text-muted-foreground">
                No trend data available
              </div>
            )}
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
}
